<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Azimuthal modes decomposition &#8212; Smilei 5.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/smilei_theme.css?v=3908db80" />
    <script src="../_static/documentation_options.js?v=4af8989d"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="icon" href="../_static/smileiIcon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Laser envelope model" href="laser_envelope.html" />
    <link rel="prev" title="Advanced numerical techniques" href="numerical_techniques.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    "HTML-CSS": {
      scale: 95,
      availableFonts: ["TeX"]
    }
  });
  </script>
   
  </head><body>

<div id="smallScreenMenu" class="off">

    
    <div class="toctree-smilei">
        <ul>
            <li class="outer">
                <a href="../Overview/synopsis.html">Synopsis</a>
            </li>
            <li class="outer">
                <a href="../Overview/highlights.html">Highlights</a>
            </li>
            <li class="outer">
                <a href="../Overview/releases.html">Releases</a>
            </li>
            <li class="outer">
                <a href="../Overview/licence.html">Licence</a>
            </li>
            <li class="outer">
                <a href="../Overview/material.html">Publications</a>
            </li>
            <li class="outer">
                <a href="../Overview/partners.html">Partners</a>
            </li>
        </ul>
        <hr />
        <ul>
            <li class="outer">
                <a href="units.html">Units</a>
            </li>
            <li class="outer">
                <a href="algorithms.html">PIC algorithms</a>
            </li>
            <li class="outer">
                <a href="performances.html">Parallelization & optimization</a>
            </li>
            <li class="outer">
                <a href="physics_modules.html">Physics modules</a>
            </li>
            <li class="outer">
                <a href="numerical_techniques.html">Advanced numerical techniques</a>
            </li>
            <li class="outer">
                <a href="PML.html">Perfectly Matched Layers</a>
            </li>
        </ul>
        <hr />
        <ul>
            <li class="outer">
                <a href="../Use/installation.html">Install</a>
            </li>
            <li class="outer">
                <a href="https://smileipic.github.io/tutorials">Smilei tutorials</a>
            </li>
            <li class="outer">
                <a href="../Use/namelist.html">Write a namelist</a>
            </li>
            <li class="outer">
                <a href="../Use/run.html">Run</a>
            </li>
            <li class="outer">
                <a href="../Use/post-processing.html">Post-process</a>
            </li>
            <li class="outer">
                <a href="../Use/contribute.html">Contribute</a>
            </li>
            <li class="outer">
                <a href="../Use/troubleshoot.html">Troubleshoot</a>
            </li>
            <li class="outer">
                <a href="../Use/GPU_version.html">GPU version</a>
            </li>
        </ul>
        <hr />
    </div>

</div>
<div id="hcontainer">
    <div id="nav_positioner">
        <div id="nav">
            <div id="nav_button" onclick="toggleNav()">
                Sections
            </div>
            <div id="nav_list" class="toctree-smilei">
                <div id="nav_title"><a href="#">Azimuthal modes decomposition</a></div>
                <ul>
<li><a class="reference internal" href="#">Azimuthal modes decomposition</a><ul>
<li><a class="reference internal" href="#mathematical-definition">Mathematical definition</a></li>
<li><a class="reference internal" href="#decomposition-of-vector-fields">Decomposition of vector fields</a></li>
<li><a class="reference internal" href="#maxwell-s-equations-in-cylindrical-geometry">Maxwell’s equations in cylindrical geometry</a></li>
<li><a class="reference internal" href="#interaction-with-the-macro-particles">Interaction with the macro-particles</a></li>
<li><a class="reference internal" href="#tips">Tips</a></li>
<li><a class="reference internal" href="#conventions-for-the-namelist">Conventions for the namelist</a></li>
<li><a class="reference internal" href="#classical-and-relativistic-poisson-s-equation">Classical and relativistic Poisson’s equation</a></li>
<li><a class="reference internal" href="#the-envelope-model-in-cylindrical-coordinates">The envelope model in cylindrical coordinates</a></li>
<li><a class="reference internal" href="#on-axis-boundary-conditions-in-fdtd">On-Axis boundary conditions in FDTD</a><ul>
<li><a class="reference internal" href="#primal-and-dual-grids">Primal and Dual grids</a></li>
<li><a class="reference internal" href="#cancellation-on-axis">Cancellation on axis</a></li>
<li><a class="reference internal" href="#transverse-field-on-axis">Transverse field on axis</a></li>
<li><a class="reference internal" href="#longitudinal-field-on-axis">Longitudinal field on axis</a></li>
<li><a class="reference internal" href="#below-axis">Below axis</a></li>
<li><a class="reference internal" href="#currents-near-axis">Currents near axis</a></li>
</ul>
</li>
</ul>
</li>
</ul>

            </div>
        </div>
    </div>
    
    <div class="headercolor">
    </div>
    <div class="hpositioner">
        <div class="header">
        <div class="logo">
            <a href="../index.html">
                <img class="logo" src="../_static/smileiLogo.svg" alt="Logo" />
            </a>
            <!--
            <div style="height:7mm; position: absolute; top:2mm; left:-32mm; padding: 1mm 2mm 0 2mm; border-radius: 2mm; background-color:#C5DCEA; background-color:var(--header_text);">
                <a href="https://indico.math.cnrs.fr/e/smilei5">
                    <img src="../_static/workshopLogo.svg" alt="workshop"
                        style="height:5mm;padding-top: 1mm;" />
                </a>
            </div>
            -->
        </div>
        <div class="menu"
            id="menu_Overview"
            
        >
            <div id="menuButton_Overview" class="menuButton"
                 onmouseenter="prepareMenu('menu_Overview')"
                 onmousedown="event.preventDefault()"
            >
                <a href="../overview.html">
                    <span>Overview</span>
                </a>
            </div>
            <div class="off" onmouseleave="leaveMenu('menu_Overview',this)">
                <div class="toctree-smilei">
                    <ul>
                        <li class="outer">
                            <a href="../Overview/synopsis.html">Synopsis</a>
                        </li>
                        <li class="outer">
                            <a href="../Overview/highlights.html">Highlights</a>
                        </li>
                        <li class="outer">
                            <a href="../Overview/releases.html">Releases</a>
                        </li>
                        <li class="outer">
                            <a href="../Overview/licence.html">Licence</a>
                        </li>
                        <li class="outer">
                            <a href="../Overview/material.html">Publications</a>
                        </li>
                        <li class="outer">
                            <a href="../Overview/partners.html">Partners</a>
                        </li>
        
                    </ul>
                </div>
            </div>
        </div>
        <div class="menu"
            id="menu_Understand"
            
        >
            <div id="menuButton_Understand" class="menuButton"
                 onmouseenter="prepareMenu('menu_Understand')"
                 onmousedown="event.preventDefault()"
            >
                <a href="../understand.html">
                    <span>Understand</span>
                </a>
            </div>
            <div class="off" onmouseleave="leaveMenu('menu_Understand',this)">
                <div class="toctree-smilei">
                    <ul>
                        <li class="outer">
                            <a href="units.html">Units</a>
                        </li>
                        <li class="outer">
                            <a href="algorithms.html">PIC algorithms</a>
                        </li>
                        <li class="outer">
                            <a href="performances.html">Parallelization & optimization</a>
                        </li>
                        <li class="outer">
                            <a href="physics_modules.html">Physics modules</a>
                        </li>
                        <li class="outer">
                            <a href="numerical_techniques.html">Advanced numerical techniques</a>
                        </li>
                        <li class="outer">
                            <a href="PML.html">Perfectly Matched Layers</a>
                        </li>
        
                    </ul>
                </div>
            </div>
        </div>
        <div class="last menu"
            id="menu_Use"
            
        >
            <div id="menuButton_Use" class="menuButton"
                 onmouseenter="prepareMenu('menu_Use')"
                 onmousedown="event.preventDefault()"
            >
                <a href="../use.html">
                    <span>Use</span>
                </a>
            </div>
            <div class="off" onmouseleave="leaveMenu('menu_Use',this)">
                <div class="toctree-smilei">
                    <ul>
                        <li class="outer">
                            <a href="../Use/installation.html">Install</a>
                        </li>
                        <li class="outer">
                            <a href="https://smileipic.github.io/tutorials">Smilei tutorials</a>
                        </li>
                        <li class="outer">
                            <a href="../Use/namelist.html">Write a namelist</a>
                        </li>
                        <li class="outer">
                            <a href="../Use/run.html">Run</a>
                        </li>
                        <li class="outer">
                            <a href="../Use/post-processing.html">Post-process</a>
                        </li>
                        <li class="outer">
                            <a href="../Use/contribute.html">Contribute</a>
                        </li>
                        <li class="outer">
                            <a href="../Use/troubleshoot.html">Troubleshoot</a>
                        </li>
                        <li class="outer">
                            <a href="../Use/GPU_version.html">GPU version</a>
                        </li>
        
                    </ul>
                </div>
            </div>
        </div>
        
        <script type="text/javascript">
            var es=document.getElementsByClassName("menuButton"), i=0;
            var evt = "ontouchend" in document ? "touchend" : "click";
            for( var i=0; i<es.length; i+=1 ) {
                es[i].addEventListener(evt, function(a){ return function(){toggleMenu(a)};}(es[i].parentNode.id));
            }
        </script>
        
        <div id="searchbox" role="search" style="display:none">
            <form class="search" action="../search.html" method="get">
              <input type="text" name="q" placeholder="Search" id="searchinput" />
              <input type="hidden" name="check_keywords" value="yes" />
              <input type="hidden" name="area" value="default" />
            </form>
        </div>
        
        <div id="searchicon" onclick="openSearch()" style="display:block">
            <svg
               xmlns="http://www.w3.org/2000/svg"
               viewBox="0 0 80 120">
              <g transform="translate(0,-932.36216)" >
                <circle
                   r="25" cy="977.51044" cx="38.078663"
                   style="opacity:1;fill:none;stroke:#ffffff;stroke:var(--header_text);stroke-width:10;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1" />
                <rect
                   transform="matrix(0.36717877,0.93015039,-0.93427297,0.35655858,0,0)"
                   rx="4.9996676" ry="7.4995141" x="947.6142" y="316.16959"
                   height="14.117695" width="46.476151"
                   style="opacity:1;fill:#ffffff;fill:var(--header_text);fill-opacity:1;stroke:none;" />
                <path
                   d="m 41.383282,962.25996 a 15,15 0 0 1 11.660107,11.6355"
                   style="opacity:1;fill:none;stroke:#ffffff;stroke:var(--header_text);stroke-width:3;stroke-linecap:round;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1" />
              </g>
            </svg>
        </div>
        <div id="closesearchicon" onclick="closeSearch()" style="display:none">
            <svg
               xmlns="http://www.w3.org/2000/svg"
               viewBox="0 0 80 120">
              <g
                 transform="translate(0,-932.36216)"
                 style="fill:none;stroke:#ffffff;stroke:var(--header_text);stroke-width:10;stroke-linecap:round;stroke-linejoin:miter;stroke-opacity:1;stroke-miterlimit:4;stroke-dasharray:none">
                <path d="m 10,962.36216 60,60.00004" />
                <path d="M 70,962.36216 10,1022.3622" />
              </g>
            </svg>
        </div>
        
        <div id="smallScreenMenuButton" onclick="event.preventDefault(); toggleSmallScreenMenu(event)">
            <svg xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg"
               viewBox="-20 -20 140 140">
              <g  style="fill:#ffffff; fill:var(--header_text);stroke:none;">
                <circle cx="15" cy="20" r="5" />
                <circle cx="35" cy="20" r="5" />
                <circle cx="85" cy="20" r="5" />
                <rect width="50" height="10" x="35" y="15" rx="0" ry="0" />
                <circle cx="15" cy="40" r="5" />
                <circle cx="35" cy="40" r="5" />
                <circle cx="85" cy="40" r="5" />
                <rect width="50" height="10" x="35" y="35" rx="0" ry="0" />
                <circle cx="15" cy="60" r="5" />
                <circle cx="35" cy="60" r="5" />
                <circle cx="85" cy="60" r="5" />
                <rect width="50" height="10" x="35" y="55" rx="0" ry="0" />
                <circle cx="15" cy="80" r="5" />
                <circle cx="35" cy="80" r="5" />
                <circle cx="85" cy="80" r="5" />
                <rect width="50" height="10" x="35" y="75" rx="0" ry="0" />
              </g>
            </svg>
        </div>
        
    </div>
    
</div>
</div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="azimuthal-modes-decomposition">
<h1>Azimuthal modes decomposition<a class="headerlink" href="#azimuthal-modes-decomposition" title="Link to this heading">¶</a></h1>
<p><strong class="program">Smilei</strong> can run in <strong>cyclindrical geometry</strong> with
a decomposition in azimuthal modes (<em>AM</em>), as described in
<a class="reference external" href="http://doi.org/10.1016/j.jcp.2008.11.017">this article</a>.
This requires a system with cylindrical symmetry or close to cylindrical symmetry
(around the <code class="docutils literal notranslate"><span class="pre">x</span></code> axis in <strong class="program">Smilei</strong>).</p>
<hr class="docutils" />
<section id="mathematical-definition">
<h2>Mathematical definition<a class="headerlink" href="#mathematical-definition" title="Link to this heading">¶</a></h2>
<figure class="align-default" id="id2">
<a class="reference internal image-reference" href="../_images/Coordinate_Reference_AMcylindrical.png"><img alt="../_images/Coordinate_Reference_AMcylindrical.png" src="../_images/Coordinate_Reference_AMcylindrical.png" style="width: 11cm;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 42 </span><span class="caption-text">Coordinates in azimuthal geometry.</span><a class="headerlink" href="#id2" title="Link to this image">¶</a></p>
</figcaption>
</figure>
<p>Any scalar field <span class="math notranslate nohighlight">\(F(x,r,\theta)\)</span> can be decomposed into a basis of
azimuthal modes, or harmonics, defined as <span class="math notranslate nohighlight">\(\exp(-im\theta)\)</span>,
where <span class="math notranslate nohighlight">\(m\)</span> is the number of the mode. Writing each Fourier coefficient
as <span class="math notranslate nohighlight">\(\tilde{F}^{m}\)</span> leads to:</p>
<div class="math notranslate nohighlight" id="equation-azimuthaldecomposition1">
<span class="eqno">(41)<a class="headerlink" href="#equation-azimuthaldecomposition1" title="Link to this equation">¶</a></span>\[F\left(x,r,\theta\right) = \textrm{Re}\left[
  \sum_{m=0}^{+\infty}\tilde{F}^{m}\left(x,r\right)\exp{\left(-im\theta\right)}
\right],\]</div>
<p>The mode <span class="math notranslate nohighlight">\(m=0\)</span> has cylindrical symmetry (no dependence
on <span class="math notranslate nohighlight">\(\theta\)</span>). The following figure shows the real part
of the first four azimuthal modes.</p>
<figure class="align-default" id="id3">
<a class="reference internal image-reference" href="../_images/AM_modes.png"><img alt="../_images/AM_modes.png" src="../_images/AM_modes.png" style="width: 15cm;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 43 </span><span class="caption-text">Real part of the first four pure azimuthal modes <span class="math notranslate nohighlight">\(exp(-im\theta)\)</span>
on the <code class="docutils literal notranslate"><span class="pre">yz</span></code> plane.</span><a class="headerlink" href="#id3" title="Link to this image">¶</a></p>
</figcaption>
</figure>
<p>Eq. <a class="reference internal" href="#equation-azimuthaldecomposition1">(41)</a> can be expanded as:</p>
<div class="math notranslate nohighlight" id="equation-azimuthaldecomposition2">
<span class="eqno">(42)<a class="headerlink" href="#equation-azimuthaldecomposition2" title="Link to this equation">¶</a></span>\[F\left(x,r,\theta\right) =
  \tilde{F}^{0}_{real}
  + \tilde{F}^{1}_{real}\cos(\theta)
  + \tilde{F}^{1}_{imag}\sin(\theta)
  + \tilde{F}^{2}_{real}\cos(2\theta)
  + \tilde{F}^{2}_{imag}\sin(2\theta) + ...\]</div>
<p>The complex coefficients <span class="math notranslate nohighlight">\(\tilde{F}^{m}\)</span> can be calculated from <span class="math notranslate nohighlight">\(F\)</span>
according to:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\tilde{F}^{m} &amp;=&amp; \frac{1}{\pi}\int_0^{2\pi} F\left(x,r,\theta\right)\exp{\left(-im\theta\right)}d\theta
&amp; \quad\textrm{ for } m&gt;0 \\
\tilde{F}^{0} &amp;=&amp; \frac{1}{2\pi}\int_0^{2\pi}F\left(x,r,\theta\right)d\theta.
&amp; \textrm{ for } m=0\end{split}\]</div>
</section>
<hr class="docutils" />
<section id="decomposition-of-vector-fields">
<h2>Decomposition of vector fields<a class="headerlink" href="#decomposition-of-vector-fields" title="Link to this heading">¶</a></h2>
<p>Vector fields can also be decomposed in azimuthal modes through a
decomposition of each of their components along the cylindrical
coordinates <span class="math notranslate nohighlight">\((\mathbf{e_x},\mathbf{e_r},\mathbf{e_\theta})\)</span>.
For example, the transverse field <span class="math notranslate nohighlight">\(\mathbf{E}_\perp\)</span> of a laser pulse
polarized in the <span class="math notranslate nohighlight">\(y\)</span> direction with cylindrically symmetric envelope
can be written as</p>
<div class="math notranslate nohighlight">
\[\begin{split}\mathbf{E}_\perp(x,r,\theta, t) &amp;= E_y(x,r,\theta, t) \mathbf{e_y} \\
  &amp;= E_r (x,r,\theta, t) \mathbf{e_r} + E_{\theta}(x,r,\theta, t) \mathbf{e_{\theta}}\\
  &amp;= E_y(x,r,t) [\cos(\theta) \mathbf{e_r} - \sin(\theta) \mathbf{e_{\theta}}].\end{split}\]</div>
<p>Thus, comparing to Eq <a class="reference internal" href="#equation-azimuthaldecomposition2">(42)</a>, we recognize
a pure azimuthal mode of order <span class="math notranslate nohighlight">\(m=1\)</span> for both <span class="math notranslate nohighlight">\(E_r\)</span>
and <span class="math notranslate nohighlight">\(E_\theta\)</span>, with the Fourier coefficients:</p>
<div class="math notranslate nohighlight">
\[ \begin{align}\begin{aligned}\begin{split}\tilde{E}^1_r (x,r,t) = E_y(x,r,t),\\\end{split}\\\tilde{E}^1_{\theta} (x,r,t) = -iE_y(x,r,t).\end{aligned}\end{align} \]</div>
<p>Similarly, an elliptically (or cylindrically) polarized laser
is described by a pure mode <span class="math notranslate nohighlight">\(m=1\)</span>, as it can be seen as the linear
superposition of two linearly polarized lasers. A difference in phase or in the polarization direction simply
corresponds to a multiplication of the Fourier coefficients by a complex exponential.</p>
<p>The AM decomposition is most suited for
physical phenomena close to cylindrical symmetry as a low number
of modes is sufficient.
For example, in a basic Laser Wakefield Acceleration setup,
a linearly-polarized laser pulse with cylindrically symmetric envelope may be
described only by the mode <span class="math notranslate nohighlight">\(m=1\)</span>.
As the wakefield wave is mainly determined by the cylindrically symmetric
ponderomotive force, it can be described by the mode <span class="math notranslate nohighlight">\(m=0\)</span>.
Thus, such a simulation only needs, in principle, two azimuthal modes.</p>
</section>
<hr class="docutils" />
<section id="maxwell-s-equations-in-cylindrical-geometry">
<h2>Maxwell’s equations in cylindrical geometry<a class="headerlink" href="#maxwell-s-equations-in-cylindrical-geometry" title="Link to this heading">¶</a></h2>
<p>In an AM simulation, the <span class="math notranslate nohighlight">\(\tilde{F}^{m}(x,r)\)</span> are stored and computed
for each scalar field and for each component of the vector fields.
Each of them is a <span class="math notranslate nohighlight">\((x,r)\)</span> grid of complex values.</p>
<p>From the linearity of Maxwell’s Equations, and assuming that the densities
and currents can also be decomposed in modes, we obtain the following
evolution of the mode <span class="math notranslate nohighlight">\(m\)</span>:</p>
<div class="math notranslate nohighlight" id="equation-maxwelleqsazimuthalmodes">
<span class="eqno">(43)<a class="headerlink" href="#equation-maxwelleqsazimuthalmodes" title="Link to this equation">¶</a></span>\[\begin{split}\partial_t \tilde{B}^m_{x} &amp;=-\frac{1}{r}\partial_r(r\tilde{E}^m_{\theta})-\frac{im}{r}\tilde{E}^m_r,\\
\partial_t \tilde{B}^m_r &amp;= \frac{im}{r}\tilde{E}^m_x+\partial_x \tilde{E}^m_{\theta},\\
\partial_t \tilde{B}^m_{\theta} &amp;=-\partial_x \tilde{E}^m_{r} + \partial_r \tilde{E}^m_{x},\\
\partial_t \tilde{E}^m_{x} &amp;=\frac{1}{r}\partial_r(r\tilde{B}^m_{\theta})+\frac{im}{r}\tilde{B}^m_r-\tilde{J}^m_{x},\\
\partial_t \tilde{E}^m_r &amp;= -\frac{im}{r}\tilde{B}^m_x-\partial_x \tilde{B}^m_{\theta}-\tilde{J}^m_{r},\\
\partial_t \tilde{E}^m_{\theta} &amp;=\partial_x \tilde{B}^m_{r} - \partial_r \tilde{B}^m_{x}-\tilde{J}^m_{\theta}.\end{split}\]</div>
<p>Thus, even in presence of a plasma, at each timestep,
these equations are solved independently.
The coupling between the modes occurs when the total electromagnetic fields
push the macro-particles, creating, in turn, the currents <span class="math notranslate nohighlight">\(\tilde{J}^m\)</span>
of their current density.</p>
</section>
<hr class="docutils" />
<section id="interaction-with-the-macro-particles">
<h2>Interaction with the macro-particles<a class="headerlink" href="#interaction-with-the-macro-particles" title="Link to this heading">¶</a></h2>
<p>The azimuthal decomposition concerns only the grid quantities
(EM fields and current densities), which are thus defined on a 2D grid,
but macro-particles evolve in a full three-dimensional
space with cartesian coordinates.</p>
<figure class="align-default" id="id4">
<a class="reference internal image-reference" href="../_images/AM_grid_particles.jpg"><img alt="../_images/AM_grid_particles.jpg" src="../_images/AM_grid_particles.jpg" style="width: 10cm;" /></a>
<figcaption>
<p><span class="caption-number">Fig. 44 </span><span class="caption-text">Blue arrows: the <code class="docutils literal notranslate"><span class="pre">x</span></code> and <code class="docutils literal notranslate"><span class="pre">r</span></code> axes of the 2D grid (red)
where the electromagnetic fields are defined.
Macro-particle positions and momenta are defined in 3D.</span><a class="headerlink" href="#id4" title="Link to this image">¶</a></p>
</figcaption>
</figure>
<p>During each iteration, the macro-particles are pushed in phase space
using reconstructed 3D cartesian electromagnetic fields
at their position <span class="math notranslate nohighlight">\((x,r,\theta)\)</span> (see Eq. <a class="reference internal" href="#equation-azimuthaldecomposition1">(41)</a>).
Then, their contribution to the current densities <span class="math notranslate nohighlight">\((J_x,J_r,J_{\theta})\)</span>
is computed to update the electromagnetic fields at the next iteration
(see Eqs <a class="reference internal" href="#equation-maxwelleqsazimuthalmodes">(43)</a>).</p>
</section>
<hr class="docutils" />
<section id="tips">
<h2>Tips<a class="headerlink" href="#tips" title="Link to this heading">¶</a></h2>
<p>Note that each mode <span class="math notranslate nohighlight">\(\tilde{F}^{m}\)</span> is a function of <span class="math notranslate nohighlight">\(x\)</span>,
the longitudinal coordinate and <span class="math notranslate nohighlight">\(r\)</span>, the radial coordinate.
Therefore, each of them is only two dimensional. Thus, the computational cost
of AM simulations scales approximately as 2D simulations multiplied by the
number of modes. However, a higher number of macro-particles might be necessary
to obtain convergence of the results (always check the convergence of your
results by increasing the number of macro-particles and modes).
A rule of thumb is to use at least 4 times the number of modes as
macro-particles along <span class="math notranslate nohighlight">\(\theta\)</span>.</p>
</section>
<hr class="docutils" />
<section id="conventions-for-the-namelist">
<h2>Conventions for the namelist<a class="headerlink" href="#conventions-for-the-namelist" title="Link to this heading">¶</a></h2>
<p>Several differences appear in the notations and definitions between
the AM and 3D geometries:</p>
<ul class="simple">
<li><p>The origin of the coordinates is on the axis of the cylinder
(see figure below).</p></li>
</ul>
<figure class="align-default" id="id5">
<img alt="../_images/AMcylindrical_vs_cartesian.png" src="../_images/AMcylindrical_vs_cartesian.png" />
<figcaption>
<p><span class="caption-number">Fig. 45 </span><span class="caption-text">Origin of coordinates in AM cylindrical and 3D cartesian.</span><a class="headerlink" href="#id5" title="Link to this image">¶</a></p>
</figcaption>
</figure>
<ul class="simple">
<li><p>The AM radial grid size (<code class="docutils literal notranslate"><span class="pre">grid_length[1]</span></code>) represents the radius
of the cylinder; not its diameter. Thus, it is half the size of
the 3D transverse grid.</p></li>
<li><p>Particles are defined 3D space, so their coordinates should be
provided in terms of <em>x</em>, <em>y</em>, <em>z</em> if needed (e.g. a <code class="docutils literal notranslate"><span class="pre">Species</span></code>
initialized with a numpy array).
However, the density profiles of particles are assimilated to
scalar fields defined on the <span class="math notranslate nohighlight">\((x,r)\)</span> grid.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Field</span></code> diagnostics really correspond to the complex fields
of each mode on <span class="math notranslate nohighlight">\((x,r)\)</span> grids. However, <code class="docutils literal notranslate"><span class="pre">Probes</span></code>
diagnostics are defined in 3D space just like the particles:
all fields are interpolated at their 3D positions, and reconstructed
by summing over the modes.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ExternalFields</span></code> are grid quantities in <span class="math notranslate nohighlight">\((x,r)\)</span> coordinates.
One must be defined for each mode.</p></li>
</ul>
</section>
<hr class="docutils" />
<section id="classical-and-relativistic-poisson-s-equation">
<h2>Classical and relativistic Poisson’s equation<a class="headerlink" href="#classical-and-relativistic-poisson-s-equation" title="Link to this heading">¶</a></h2>
<p>Given the linearity of the relativistic Poisson’s equation
described in <a class="reference internal" href="relativistic_fields_initialization.html"><span class="doc">Field initialization for relativistic species</span></a>,
it can be decomposed in azimuthal modes
with the corresponding mode of the charge density
<span class="math notranslate nohighlight">\(-\tilde{\rho}^m\)</span> as source term.
For the mode <em>m</em> of the potential <span class="math notranslate nohighlight">\(\Phi\)</span>,
it writes:</p>
<div class="math notranslate nohighlight" id="equation-relpoissonmodes">
<span class="eqno">(44)<a class="headerlink" href="#equation-relpoissonmodes" title="Link to this equation">¶</a></span>\[\left[
  \frac{1}{\gamma^2_0}\partial^2_x\tilde{\Phi}^m
  +\frac{1}{r}\partial_r\left(r\partial_r\tilde{\Phi}^m\right)
  -\frac{m^2}{r^2}\tilde{\Phi}^m
\right] = -\tilde{\rho}^m.\]</div>
<p>By solving each of these relativistic Poisson’s equations
we initialize the azimuthal components of the electromagnetic fields:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{eqnarray}
\tilde{E}^m_x &amp;=&amp; -\frac{1}{\gamma_0^2}\partial_x \tilde{\Phi}^m,\\
\tilde{E}^m_r &amp;=&amp; -\partial_r \tilde{\Phi}^m, \\
\tilde{E}^m_{\theta} &amp;=&amp; \frac{im}{r} \tilde{\Phi}^m, \\
\tilde{\mathbf{B}}^m &amp;=&amp; \beta_0\mathbf{\hat{x}}\times\tilde{\mathbf{E}}^m.
\end{eqnarray}\end{split}\]</div>
<p>The initialization of the electric field with the non-relativistic
Poisson’s equation is performed similarly, and the underlying equations simply
reduce to the previous equations, with <span class="math notranslate nohighlight">\(\gamma_0 = 1\)</span> and
<span class="math notranslate nohighlight">\(\beta_0 = 0\)</span> (i.e. an immobile Species).</p>
</section>
<hr class="docutils" />
<section id="the-envelope-model-in-cylindrical-coordinates">
<h2>The envelope model in cylindrical coordinates<a class="headerlink" href="#the-envelope-model-in-cylindrical-coordinates" title="Link to this heading">¶</a></h2>
<p>The <a class="reference internal" href="laser_envelope.html"><span class="doc">Laser envelope model</span></a> for cartesian geometries has been
implemented also in cylindrical geometry, as described in <a class="reference internal" href="../Overview/material.html#massimo2020b" id="id1"><span>[Massimo2020b]</span></a>.</p>
<p>Only the mode <span class="math notranslate nohighlight">\(m=0\)</span> is available for the envelope
in the present implementation, i.e. the electromagnetic and
envelope fields have perfect cylindrical symmetry with respect
to the envelope propagation axis <span class="math notranslate nohighlight">\(x\)</span>.</p>
<p>The main difference compared to the cartesian geometry lies in the envelope
equation (see Eq. <a class="reference internal" href="laser_envelope.html#equation-envelope-equation">(50)</a>). The assumption of cylindrical
symmetry removes derivatives with respect <span class="math notranslate nohighlight">\(\theta\)</span>, leading to:</p>
<div class="math notranslate nohighlight" id="equation-envelope-equation-am">
<span class="eqno">(45)<a class="headerlink" href="#equation-envelope-equation-am" title="Link to this equation">¶</a></span>\[\partial^2_x\tilde{A}
+\frac{1}{r}\partial_r(r\partial_r\tilde{A})
+2i\left(\partial_x \tilde{A} + \partial_t \tilde{A}\right)
-\partial^2_t\tilde{A}
=   \chi \tilde{A}.\]</div>
<p>The envelope approximation coupled to the cylindrical symmetry
can greatly speed-up the simulation: compared to a 3D envelope simulation
with the same number of particles, it has a speed-up which scales linearly
as twice the transverse number of cells.
This speed-up can reach 100 for lasers with transverse sizes of the order
of tens of microns. Compared to a standard 3D laser simulation with the
same number of particles, the speed-up of a cylindrical envelope simulation
can reach 1000 for lasers of durations of the order of tens of femtoseconds.
These comparisons assume the same longitudinal window size and the same
transverse size for the simulated physical space.</p>
</section>
<hr class="docutils" />
<section id="on-axis-boundary-conditions-in-fdtd">
<h2>On-Axis boundary conditions in FDTD<a class="headerlink" href="#on-axis-boundary-conditions-in-fdtd" title="Link to this heading">¶</a></h2>
<p>In the AM geometry, specific boundary conditions are derived on-axis for the FDTD solver using a Yee lattice.
This section presents the actual implementation in <strong class="program">Smilei</strong>.
It is mostly based on the <a class="reference external" href="http://doi.org/10.1016/j.jcp.2008.11.017">original paper</a> but also includes
original contributions from X. Davoine and the <strong class="program">Smilei</strong> team.</p>
<section id="primal-and-dual-grids">
<h3>Primal and Dual grids<a class="headerlink" href="#primal-and-dual-grids" title="Link to this heading">¶</a></h3>
<p>In <strong class="program">Smilei</strong>, ghost cells in the radial direction are located “before” the axis.
So if you have <span class="math notranslate nohighlight">\(N_{ghost}\)</span> ghost cells, you have as many primal points on the radial axis before
reaching the actual geometric axis <span class="math notranslate nohighlight">\(r=0\)</span>.
If <span class="math notranslate nohighlight">\(dr\)</span> is a radial cell size, the dual radial axis is shifted by <span class="math notranslate nohighlight">\(-dr/2\)</span>.
Below is an example for <span class="math notranslate nohighlight">\(N_{ghost}=2\)</span>.
All equations in this section are given for this specific case.
For different numbers of ghost cells, simply add the difference in all indices.
<span class="math notranslate nohighlight">\(jp\)</span> and <span class="math notranslate nohighlight">\(jd\)</span> stand for the primal and dual indices.</p>
<figure class="align-default">
<a class="reference internal image-reference" href="../_images/transverse_axis.png"><img alt="../_images/transverse_axis.png" src="../_images/transverse_axis.png" style="width: 10cm;" /></a>
</figure>
</section>
<section id="cancellation-on-axis">
<h3>Cancellation on axis<a class="headerlink" href="#cancellation-on-axis" title="Link to this heading">¶</a></h3>
<p>The first basic principle is that a mode 0 field defined on axis can only be longitudinal otherwise it would be ill defined.
On the opposite, longitudinal fields on axis can only be of mode 0 since they do not depend on <span class="math notranslate nohighlight">\(\theta\)</span>.
From this we can already state that <span class="math notranslate nohighlight">\(E_r^{m=0},\ E_t^{m=0},\ B_r^{m=0},\ B_t^{m=0},\ E_l^{m&gt;0},\ B_l^{m&gt;0}\)</span> are zero on axis.</p>
<p>This condition is straight forward for primal fields in R which take a value on axis exactly.
We simply set this value to zero.</p>
<div class="math notranslate nohighlight">
\[ \begin{align}\begin{aligned}E_{\theta}^{m=0}[2] = 0\\B_r^{m=0}[2] = 0\\E_l^{m&gt;0}[2] = 0\end{aligned}\end{align} \]</div>
<p>For dual fields in R, we set a value such as a linear interpolation between nearest grid points gives a zero on axis.</p>
<div class="math notranslate nohighlight">
\[ \begin{align}\begin{aligned}E_r^{m=0}[2] = -E_r^{m=0}[3]\\B_{\theta}^{m=0}[2] = -B_{\theta}^{m=0}[3]\\B_l^{m&gt;0}[2] = -B_l^{m&gt;0}[3]\end{aligned}\end{align} \]</div>
</section>
<section id="transverse-field-on-axis">
<h3>Transverse field on axis<a class="headerlink" href="#transverse-field-on-axis" title="Link to this heading">¶</a></h3>
<p>The transverse electric field can be written as follows</p>
<div class="math notranslate nohighlight">
\[\mathbf{E_\perp} = \mathbf{E_y} + \mathbf{E_z} = (E_r\cos{\theta}-E_{\theta}\sin{\theta})\mathbf{e_y} + (E_r\sin{\theta}+E_{\theta}\cos{\theta})\mathbf{e_z}\]</div>
<p>The transverse field on axis can not depend on <span class="math notranslate nohighlight">\(\theta\)</span> otherwise it would be ill defined.
Therefore we have the following condition on axis:</p>
<div class="math notranslate nohighlight">
\[\frac{\partial\mathbf{E_\perp}}{\partial\theta} = 0\ \forall\theta\]</div>
<p>which leads to the following relation:</p>
<div class="math notranslate nohighlight">
\[\cos{\theta}\left(\frac{\partial E_r}{\partial\theta}-E_{\theta}\right) + \sin{\theta}\left(\frac{\partial E_{\theta}}{\partial\theta}+E_r\right)=0\ \forall\theta\]</div>
<p>Being true for all <span class="math notranslate nohighlight">\(\theta\)</span>, this leads to</p>
<div class="math notranslate nohighlight">
\[ \begin{align}\begin{aligned}\frac{\partial E_r}{\partial\theta}-E_{\theta}=0\ \forall\theta\\\frac{\partial E_{\theta}}{\partial\theta}+E_r=0\ \forall\theta\end{aligned}\end{align} \]</div>
<p>Remembering that for a given mode <span class="math notranslate nohighlight">\(m\)</span> and a given field <span class="math notranslate nohighlight">\(F\)</span>, we have <span class="math notranslate nohighlight">\(F=Re\left(\tilde{F}^m\exp{(-im\theta)}\right)\)</span>,
we can write the previous equations for all modes <span class="math notranslate nohighlight">\(m\)</span> as follows:</p>
<div class="math notranslate nohighlight" id="equation-transverse-on-axis">
<span class="eqno">(46)<a class="headerlink" href="#equation-transverse-on-axis" title="Link to this equation">¶</a></span>\[ \begin{align}\begin{aligned} \tilde{E_r}^m=\frac{i\tilde{E_{\theta}}^m}{m}\\ \tilde{E_r}^m=mi\tilde{E_{\theta}}^m\end{aligned}\end{align} \]</div>
<p>We have already established in the previuos section that the modes <span class="math notranslate nohighlight">\(m=0\)</span> must cancel on axis and we are concerned only about <span class="math notranslate nohighlight">\(m&gt;0\)</span>.
Equations <a class="reference internal" href="#equation-transverse-on-axis">(46)</a> can have a non zero solution only for <span class="math notranslate nohighlight">\(m=1\)</span> and is also valid for the magnetic field.
We therefore conclude that all modes must cancel on axis except for <span class="math notranslate nohighlight">\(m=1\)</span>.</p>
<div class="math notranslate nohighlight">
\[ \begin{align}\begin{aligned}\tilde{E_{\theta}}^{m&gt;1}[2] = 0\\\tilde{B_r}^{m&gt;1}[2] = 0\\\tilde{E_r}^{m&gt;1}[2] = -\tilde{E_r}^{m&gt;1}[3]\\\tilde{B_{\theta}}^{m&gt;1}[2] = -\tilde{B_{\theta}}^{m&gt;1}[3]\end{aligned}\end{align} \]</div>
<p>Let’s now write the Gauss law for mode <span class="math notranslate nohighlight">\(m=1\)</span>:</p>
<div class="math notranslate nohighlight">
\[div(\mathbf{\tilde{E}^{m=1}})=\tilde{\rho}^{m=1}\]</div>
<p>where <span class="math notranslate nohighlight">\(\rho\)</span> is the charge density.
We have already established that on axis the longitudinal field are zero for all modes <span class="math notranslate nohighlight">\(m&gt;0\)</span>.
The charge density being a scalar field, it follows the same rule and is zero as well on axis.
The continuity equation on axis and written in cylindrical coordinates becomes:</p>
<div class="math notranslate nohighlight">
\[\frac{\tilde{E_r}^{m=1}-im\tilde{E_{\theta}}^{m=1}}{r} + \frac{\partial \tilde{E_r}^{m=1}}{\partial r} = 0\]</div>
<p>Eq. <a class="reference internal" href="#equation-transverse-on-axis">(46)</a> already establishes that the first term is zero.
It is only necessary to cancel the second term.
To ensure this derivative cancels on axis we simply pick:</p>
<div class="math notranslate nohighlight">
\[\tilde{E_r}^{m=1}[2] = \tilde{E}_r^{m=1}[3]\]</div>
<p>And equation <a class="reference internal" href="#equation-transverse-on-axis">(46)</a> then gives</p>
<div class="math notranslate nohighlight">
\[\tilde{E_{\theta}}^{m=1}(r=0) = -i\tilde{E_r}^{m=1}(r=0)\]</div>
<p>With a finite difference scheme, this is implemented as</p>
<div class="math notranslate nohighlight">
\[\tilde{E_{\theta}}^{m=1}[2] = -\frac{i}{8}(9\tilde{E_r}^{m=1}[3]-\tilde{E_r}^{m=1}[4])\]</div>
<p>All the equation derived here are also valid for the magnetic field.
But because of a different duality, it is more convenient to use a different approach.
The equations <a class="reference internal" href="#equation-maxwelleqsazimuthalmodes">(43)</a> has a <span class="math notranslate nohighlight">\(\frac{\tilde{E_l}}{r}\)</span> term in the expression of <span class="math notranslate nohighlight">\(B_r\)</span> which makes it undefined on axis.
Nevertheless, we need to evaluate this term for the mode <span class="math notranslate nohighlight">\(m=1\)</span> and it can be done as follows.</p>
<div class="math notranslate nohighlight">
\[\lim_{r\to 0}\frac{E_l^{m=1}(r)}{r} = \lim_{r\to 0}\frac{E_l^{m=1}(r)-E_l^{m=1}(0)}{r}\]</div>
<p>since we established in the previous section that <span class="math notranslate nohighlight">\(E_l^{m=1}(r=0)=0\)</span>.
And by definition of a derivative we have:</p>
<div class="math notranslate nohighlight">
\[\lim_{r\to 0}\frac{E_l^{m=1}(r)-E_l^{m=1}(0)}{r}=\frac{\partial E_l^{m=1} }{\partial r}(r=0)\]</div>
<p>This derivative can be evaluated by a simple finite difference scheme and using again that  <span class="math notranslate nohighlight">\(E_l^{m=1}\)</span> is zero on axis we get:</p>
<div class="math notranslate nohighlight" id="equation-derivative-limit">
<span class="eqno">(47)<a class="headerlink" href="#equation-derivative-limit" title="Link to this equation">¶</a></span>\[\lim_{r\to 0}\frac{E_l^{m=1}(r)}{r} = \frac{E_l^{m=1}(dr)}{dr}\]</div>
<p>Introducing this result in the standard FDTD scheme for <span class="math notranslate nohighlight">\(B_r\)</span> we get the axis bounday condition:</p>
<div class="math notranslate nohighlight">
\[B_{r}^{m=1,n+1}[i,2] = B_{r}^{m=1,n}[i,2] + dt\left(\frac{i}{dr}E_l^{m=1}[i,3]+\frac{E_{\theta}^{m=1}[i+1,2]-E_{\theta}^{m=1}[i,2]}{dl}\right)\]</div>
<p>where the <span class="math notranslate nohighlight">\(n\)</span> indice indicates the time step and <span class="math notranslate nohighlight">\(i\)</span> the longitudinal indice.</p>
</section>
<section id="longitudinal-field-on-axis">
<h3>Longitudinal field on axis<a class="headerlink" href="#longitudinal-field-on-axis" title="Link to this heading">¶</a></h3>
<p>We have alreayd established that only modes <span class="math notranslate nohighlight">\(m=0\)</span> of longitudinal fields are non zero on axis.
In order to get an evaluation of <span class="math notranslate nohighlight">\(E_l^{m=0}\)</span> on axis one can use the same approach as for <span class="math notranslate nohighlight">\(B_r^{m=1}\)</span>.
Since we have already shown that <span class="math notranslate nohighlight">\(E_{\theta}^{m=0}\)</span> is zero on axis, we have the following relation which is demonstrated using
similar arguments as Eq. <a class="reference internal" href="#equation-derivative-limit">(47)</a>:</p>
<div class="math notranslate nohighlight">
\[\lim_{r\to 0}\frac{1}{r}\frac{\partial rB_{\theta}^{m=0}}{\partial r} = \frac{4B_{\theta}^{m=0}(dr/2)}{dr}\]</div>
<p>Introducing this result in the standard FDTD expression of <span class="math notranslate nohighlight">\(E_l\)</span> we get:</p>
<div class="math notranslate nohighlight">
\[E_{l}^{m=0,n+1}[i,2] = E_{l}^{m=0,n}[i,2] + dt\left(\frac{4}{dr}B_{\theta}^{m=0}[i,3]-J_{l}^{m=0}[i,2]\right)\]</div>
<p>Again, the <span class="math notranslate nohighlight">\(n\)</span> indice indicates the time step here.</p>
</section>
<section id="below-axis">
<h3>Below axis<a class="headerlink" href="#below-axis" title="Link to this heading">¶</a></h3>
<p>Fields “below” axis are primal fields data with indice <span class="math notranslate nohighlight">\(j&lt;2\)</span> and dual fields with indice <span class="math notranslate nohighlight">\(j&lt;3\)</span>.
These fields are not physical in the sense that they do not contribute to the reconstruction of any physical field in real space and are not obtained by solving Maxwell’s equations.
Nevertheless, it is numerically convenient to give them a value in order to facilitate field interpolation for macro-particles near axis.
This is already what is done for dual fields in <span class="math notranslate nohighlight">\(r\)</span> which cancel on axis for instance.
We extend this logic to primal fields in <span class="math notranslate nohighlight">\(r\)</span> as well.
For any given field <span class="math notranslate nohighlight">\(F\)</span>, the symetric of <span class="math notranslate nohighlight">\(F\)</span> with respect to the axis is <span class="math notranslate nohighlight">\(F\)</span> if <span class="math notranslate nohighlight">\(F\)</span> is non zero on axis and <span class="math notranslate nohighlight">\(-F\)</span> if <span class="math notranslate nohighlight">\(F\)</span> is zero on axis:</p>
<div class="math notranslate nohighlight">
\[ \begin{align}\begin{aligned}E_{l}^{m=0}[1] = E_{l}^{m=0}[3]\\E_{l}^{m&gt;0}[1] = -E_{l}^{m&gt;0}[3]\\E_{r}^{m\neq1}[2] = -E_{r}^{m\neq1}[3]\\E_{r}^{m=1}[2] = E_{r}^{m=1}[3]\\E_{\theta}^{m\neq1}[1] = -E_{\theta}^{m\neq1}[3]\\E_{\theta}^{m=1}[1] = E_{\theta}^{m=1}[3]\\B_{l}^{m=0}[2]=B_{l}^{m=0}[3]\\B_{l}^{m&gt;0}[2]=-B_{l}^{m&gt;0}[3]\\B_{r}^{m\neq1}[1] = -B_{r}^{m\neq1}[3]\\B_{r}^{m=1}[1] = B_{r}^{m=1}[3]\\B_{t}^{m\neq1}[2] = -B_{t}^{m\neq1}[3]\\B_{t}^{m=1}[2] = B_{t}^{m=1}[3]\end{aligned}\end{align} \]</div>
</section>
<section id="currents-near-axis">
<h3>Currents near axis<a class="headerlink" href="#currents-near-axis" title="Link to this heading">¶</a></h3>
<p>A specific treatment must be applied to charge and current densities near axis because the projector deposits charge and current “below” axis.
Quantities below axis must be folded back onto their symetric “above” axis.
Mode 0 contributions below axis are added to their “above axis” counterparts.
On the opposite, strictly positive modes contributions are deduced.
This ensures that a particle sitting on axis will have a net contribution to the domain only in mode 0 as expected because in that case <span class="math notranslate nohighlight">\(\theta\)</span> is not defined and therefore
the deposition can not be a function of <span class="math notranslate nohighlight">\(\theta\)</span>.</p>
<p>Using the continuity equation instead of Gauss law for transverse current of mode <span class="math notranslate nohighlight">\(m=1\)</span> on axis, we can derive the exact same boundary conditions
on axis for current density as for the electric field.</p>
</section>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      <div>
        <input type="button" id="themebutton"  value="" onclick="switchTheme('')" />
      </div>
      <div>
      <a href="site.html">Site index</a>
      </div>
      <div>
        Last updated on May 26, 2025
      </div>
      
      <div>
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.2.6</a>
      </div>
      
    </div>
    
    <script type="text/javascript">
        
        var nav = document.getElementById("nav");
        var nav_list = document.getElementById("nav_list");
        var nav_button = document.getElementById("nav_button");
        var smallScreenMenu = document.getElementById("smallScreenMenu");
        var smallScreenMenuButton = document.getElementById("smallScreenMenuButton");
        var searchicon = document.getElementById("searchicon");
        var searchbox  = document.getElementById("searchbox");
        var searchinput= document.getElementById("searchinput");
        var menus = document.getElementsByClassName("menu");
        for( var i=0; i<menus.length; i++ )
            menus[i].active = false;
        
        // Manage theme
        var theme="light";
        function switchTheme(type) {
            if( type == "dark" || ( ! type && theme == "light" ) ) {
                theme = "dark";
                document.documentElement.setAttribute('theme', 'dark');
                window.name = "dark_theme"
                localStorage.setItem("_theme","dark")
            } else {
                theme = "light";
                document.documentElement.setAttribute('theme', 'light');
                window.name = "light_theme"
                localStorage.setItem("_theme","light")
            }
        }
        if( window.name && window.name == "light_theme" ) {
            switchTheme("light");
        } else if ( window.name && window.name == "dark_theme" ) {
            switchTheme("dark");
        } else if( stored_theme = localStorage.getItem("_theme") ) {
            switchTheme(stored_theme);
        } else if( window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches) {
            switchTheme("dark");
        }
        
        var ul = nav_list.getElementsByTagName("ul")[0], li;
        var keep_nav = false;
        if( ul ) {
            li = ul.firstElementChild;
            if( li ) {
                if( li.getElementsByTagName("ul").length > 0 ) keep_nav = true;
            }
        }
        if( keep_nav ) {
            li.removeChild( li.firstElementChild );
        } else {
            document.getElementById("nav_positioner").removeChild( document.getElementById("nav") );
        }
        
        function navOff() {
            nav_list.style.display = "none";
            nav_button.className = "";
            nav.style.overflowY = "visible";
        }
        
        function toggleNav() {
            for( var i=0; i<menus.length; i++ )
                menuOff( menus[i] );
            if( nav_list.style.display != "inline-block" ) {
                nav_list.style.display = "inline-block";
                nav_button.className = "pushed";
                nav.style.overflowY = "auto";
            } else {
                navOff();
            }
        }
        
        function toggleSmallScreenMenu(e) {
            if( smallScreenMenu.className != "on" ) {
                smallScreenMenu.className = "on";
                smallScreenMenuButton.className = "pushed";
                document.documentElement.style.overflow = "hidden";
            } else {
                smallScreenMenu.className = "off";
                smallScreenMenuButton.className = "";
                document.documentElement.style.overflow = "";
            }
        }
        
        if (smallScreenMenuAfterTOC = document.getElementById("smallScreenMenuAfterTOC")) {
            var smallScreenMenuTOC = smallScreenMenuAfterTOC.previousElementSibling
                .getElementsByTagName("li")[0].getElementsByTagName("ul")[0].getElementsByTagName("li");
            for (var i = 0; i < smallScreenMenuTOC.length; i++) {
                if (smallScreenMenuTOC[i].tagName = "a") {
                    smallScreenMenuTOC[i].addEventListener("click", function(event){ toggleSmallScreenMenu(event); } );
                }
            }
        }
        
        function prepareMenu(menu_id) {
            var menu = document.getElementById(menu_id);
            menu.timer1 = setTimeout(function(a){ return function(){thisMenuOnly(a)};}(menu_id), 100);
            menu.addEventListener("mouseleave", function(a){ return function(){clearTimeout(a.timer1)};}(menu) );
        }
        
        function leaveMenu(menu_id, source) {
            var menu = document.getElementById(menu_id);
            menu.timer2 = setTimeout(function(a){ return function(){menuOff(a)};}(menu), 1000);
            source.addEventListener("mouseenter", function(a){ return function(){clearTimeout(a.timer2)};}(menu) );
        }
        
        function menuOn( menu ) {
            var divs = menu.getElementsByTagName("div");
            if(nav_list) navOff();
            divs[1].className = "on";
            divs[0].className = "menuButton pushed";
            menu.active = true;
        }
        function menuOff( menu ) {
            var divs = menu.getElementsByTagName("div");
            divs[1].className = "off";
            divs[0].className = "menuButton";
            menu.active = false;
        }
        
        function thisMenuOnly(menu_id) {
            var menu = document.getElementById(menu_id);
            for( var i=0; i<menus.length; i++ )
                if( i!=menu_id )
                    menuOff( menus[i] );
            menuOn( menu );
        }
        
        function toggleMenu(menu_id) {
            var menu = document.getElementById(menu_id);
            if( menu.active ) {
                menuOff( menu );
            } else {
                for( var i=0; i<menus.length; i++ )
                    if( i!=menu_id )
                        menuOff( menus[i] );
                menuOn( menu );
            }
        }
        
        function openSearch() {
            for( var i=0; i<menus.length; i++ ) {
                menuOff( menus[i] );
                menus[i].style.zIndex = "-1";
            }
            searchicon.style.display = "none";
            closesearchicon.style.display = "block";
            searchbox.style.display = "block";
            searchinput.focus();
        }
        
        function closeSearch() {
            searchicon.style.display = "block";
            closesearchicon.style.display = "none";
            searchbox .style.display = "none";
            for( var i=0; i<menus.length; i++ )
                menus[i].style.zIndex = "0";
        }
        
        
        var documentDiv = document.getElementsByClassName("document")[0];
        documentDiv.addEventListener('click', function (event) {
            if(nav_list) navOff();
            for( var i=0; i<menus.length; i++ )
                menuOff( menus[i] );
        });
    </script>
  </body>
</html>